# ==============================================================================
# Docker Compose Override para Desarrollo Local
# Este archivo extiende docker-compose.yml con configuraciones específicas para desarrollo local
# ==============================================================================
# Uso: docker-compose -f docker-compose.yml -f docker-compose.local.yml up -d
#
# Este override proporciona conveniencias para desarrollo local:
# - Puertos expuestos para acceso directo
# - Base de datos PostgreSQL local para Kong (konga-db se hereda del base)
# - Volume mounts para cambios de configuración en vivo
# - Debug logging habilitado
# - Sin requisitos SSL

services:
  # ===========================================================================
  # PostgreSQL para Kong (Base de datos SOLO para desarrollo local)
  # ===========================================================================
  kong-db:
    image: postgres:15-alpine
    container_name: kong-db
    environment:
      POSTGRES_DB: kong
      POSTGRES_USER: kong
      POSTGRES_PASSWORD: kong_local_password
    ports:
      - "15432:5432" # Acceso externo para debugging (interno sigue siendo 5432)
    volumes:
      - kong-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U kong"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - kong-net

  # ===========================================================================
  # Konga DB - Override para desarrollo local con puerto expuesto
  # ===========================================================================
  konga-db:
    ports:
      - "13306:3306" # Acceso externo para debugging (interno sigue siendo 3306)
    environment:
      MYSQL_ROOT_PASSWORD: konga_root_local
      MYSQL_DATABASE: konga
      MYSQL_USER: konga
      MYSQL_PASSWORD: konga_local_password
    volumes:
      - konga-db-data:/var/lib/mysql
    command: --default-authentication-plugin=mysql_native_password
    healthcheck:
      test:
        [
          "CMD",
          "mysqladmin",
          "ping",
          "-h",
          "localhost",
          "-u",
          "konga",
          "-pkonga_local_password",
        ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===========================================================================
  # Kong Gateway Bootstrap - Carga configuración local
  # ===========================================================================
  kong-deck-bootstrap:
    volumes:
      - ./config/kong/kong-nonprod.yaml:/config/kong.yaml:ro
    restart: "no"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "2"

  # ===========================================================================
  # Kong Gateway
  # ===========================================================================
  kong:
    environment:
      # Conectar a base de datos PostgreSQL local
      - KONG_DATABASE=postgres
      - KONG_PG_HOST=kong-db
      - KONG_PG_PORT=5432
      - KONG_PG_DATABASE=kong
      - KONG_PG_USER=kong
      - KONG_PG_PASSWORD=kong_local_password
      - KONG_PG_SSL=off
      - KONG_PG_SSL_VERIFY=off
      # Logging detallado para debugging
      - KONG_LOG_LEVEL=debug
      - KONG_PROXY_ACCESS_LOG=/dev/stdout
      - KONG_ADMIN_ACCESS_LOG=/dev/stdout
      - KONG_PROXY_ERROR_LOG=/dev/stderr
      - KONG_ADMIN_ERROR_LOG=/dev/stderr
    ports:
      - "8000:8000" # Kong Proxy
      - "8001:8001" # Kong Admin API
      # - "18443:8443" # Kong Proxy SSL
      # - "18444:8444" # Kong Admin API SSL
    volumes:
      - ./config/kong-local.conf:/etc/kong/kong.conf:ro
    depends_on:
      kong-db:
        condition: service_healthy
    restart: unless-stopped

  # ===========================================================================
  # Kong Migrations - Override para usar DB local
  # ===========================================================================
  kong-migrations:
    environment:
      - KONG_DATABASE=postgres
      - KONG_PG_HOST=kong-db
      - KONG_PG_PORT=5432
      - KONG_PG_DATABASE=kong
      - KONG_PG_USER=kong
      - KONG_PG_PASSWORD=kong_local_password
      - KONG_PG_SSL=off
      - KONG_PG_SSL_VERIFY=off
    depends_on:
      kong-db:
        condition: service_healthy

  # ===========================================================================
  # Konga (Kong Admin UI)
  # ===========================================================================
  konga:
    environment:
      # Conectar a konga-db (heredado del compose base)
      - DB_ADAPTER=mysql
      - DB_HOST=konga-db
      - DB_PORT=3306
      - DB_USER=konga
      - DB_PASSWORD=konga_local_password
      - DB_DATABASE=konga
      # Configuración de ambiente local
      - NODE_ENV=development
      - KONGA_LOG_LEVEL=debug
    ports:
      - "1337:1337" # Konga UI (acceso directo)
    depends_on:
      konga-db:
        condition: service_healthy
    restart: unless-stopped

  # ===========================================================================
  # Nginx Reverse Proxy
  # ===========================================================================
  konga-proxy:
    ports:
      - "3366:80" # Puerto personalizado para evitar conflictos
    volumes:
      - ./config/nginx-konga.conf:/etc/nginx/nginx.conf:ro
    restart: unless-stopped

# ===========================================================================
# Volúmenes para persistir datos locales
# ===========================================================================
volumes:
  kong-db-data:
    driver: local
  konga-db-data:
    driver: local # Override del volumen base para usar almacenamiento local

networks:
  kong-net:
    driver: bridge
